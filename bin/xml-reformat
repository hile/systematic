#!/usr/bin/env python

from lxml import etree as ET
from lxml.etree import XMLSyntaxError

from systematic.shell import Script,ScriptError

script = Script()
script.add_option('-c','--remove-comments',action='store_true',help='Remove comments')
script.add_option('-r','--replace',action='store_true',help='Replace original file')
(opts,args) = script.parse_args()

if not len(args):
    script.exit(1,script.get_usage())

parser = ET.XMLParser(remove_blank_text=True,remove_comments=opts.remove_comments)
for path in args:
    try:
        tree = ET.parse(path,parser=parser)
    except XMLSyntaxError,emsg:
        print emsg
        continue
    if opts.replace:
        output = ET.tostring(tree,pretty_print=True)
        old = open(path,'r').read()
        if old!=output:
            try:
                script.log.debug('Writing file: %s' % path)
                open(path,'w').write(ET.tostring(tree,pretty_print=True))
            except IOError,(ecode,emsg):
                script.exit(1,'Error writing to file %s: %s' % (path,emsg))
        else:
            script.log.debug('XML tree was not modified, not writing')
    else:
        print ET.tostring(tree,pretty_print=True)

