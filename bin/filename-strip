#!/usr/bin/env python

import os,re
from systematic.shell import Script

MOVE_ENDINGS = {
    ', The': 'The ',
    ', A': 'A ',
}

script = Script()
script.add_option('-s','--string',help='String to remove')
script.add_option('-n','--newstring',help='String to replace with')
script.add_option('-r','--regexp',action='store_true',help='String is regexp')
script.add_option('-y','--dry-run',action='store_true',help='Do not rename, just list new names')
(opts,args) = script.parse_args()

if not opts.string:
    print 'String option is required'
    script.exit(1,script.get_usage())

newstring = opts.newstring and opts.newstring or ''

for path in args:
    if opts.regexp:
        newname = re.sub(opts.string,newstring,path)
    else:
        newname = path.replace(opts.string,newstring)
    basename,ext = os.path.splitext(newname)
    for ending,prefix in MOVE_ENDINGS.items():
        if basename[-len(ending):]==ending:
            newname = prefix+basename[:-len(ending)] + ext
            break
    if newname == path:
        continue
    if opts.dry_run:
        print '%s -> %s' % (path,newname)
    else:
        try:
            os.rename(path,newname)
        except IOError,(ecode,emsg):
            script.exit(1,'Error renaming %s: %s' % (path,emsg))
