#!/usr/bin/env python
"""
Script to load and view ssh keys found from user directories
"""

import os

from systematic.shell import Script
from systematic.sshconfig import UserSSHKeys

DEFAULT_CONFIG = os.path.expanduser('~/.ssh/sshkeys.conf')

script = Script()
script.add_argument('-l','--list',action='store_true',help='List loaded keys')
script.add_argument('-k','--keys',action='store_true',help='List available keys')
script.add_argument('-s','--status',action='store_true',help='List key load status')
script.add_argument('-a','--load',action='store_true',help='Load all keys to agent')
script.add_argument('-u','--unload',action='store_true',help='Unload all agent keys')
script.add_argument('-c','--config',default=DEFAULT_CONFIG,help='Configuration file path')
args = script.parse_args()

usk = UserSSHKeys()
if os.path.isfile(args.config):
    usk.read_config(path=args.config)

if args.list:
    for k in usk.sshagent_loaded_keys().values():
        print """%(path)s
  Algorithm:   %(algorithm)s
  Key Bits:    %(bits)s
  Fingerprint: %(fingerprint)s
        """ % k

if args.keys:
    for k in filter(lambda x: x.available, usk.values()):
        print """%(path)s
  Algorithm:   %(algorithm)s
  Key Bits:    %(bits)s
  Fingerprint: %(fingerprint)s
""" % k

if args.status:
    for k in usk.values():
        if k.available:
            status = k.is_loaded and 'LOADED' or 'UNLOADED'
        else:
            status = 'UNAVAILABLE'
        print '%12s %s' % (status,k.path)

if args.load:
    for k in filter(lambda k: k.available and k.autoload and not k.is_loaded, usk.values()):
        k.load()

if args.unload:
    for k in filter(lambda k: k.is_loaded, usk.values()):
        k.unload()
